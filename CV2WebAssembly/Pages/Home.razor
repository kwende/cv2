@page "/"

@inject ILogger<Home> _logger;
@inject IJSRuntime _jsRuntime;
@inject PresetClient _presetClient; 

@page "/sprite-editor"
@using CV2WebAssembly.Services
@using Common
@using MudBlazor
@using CV2WebAssembly.Pages
@using Serilog


<MudAppBar Color="Color.Primary" Elevation="1">
	<MudText Typo="Typo.h6">NES Sprite Editor</MudText>
</MudAppBar>

<MudPaper Elevation="0" Class="pa-0">
	<MudToolBar Dense="true" DisableGutters="true" Class="px-2" Style="min-height: 32px; background-color: #f5f5f5;">
		<MudMenu Label="File" Variant="Variant.Text" Size="Size.Small" Dense="true" Class="pa-0 ma-0">
			<MudMenuItem Icon="@Icons.Material.Filled.FolderOpen" IconSize="Size.Small" OnClick="OnOpenRomClick">Open ROM...</MudMenuItem>
			<MudMenuItem Icon="@Icons.Material.Filled.Save" IconSize="Size.Small" OnClick="OnSaveClick" Disabled="@(!RomLoaded)">Save</MudMenuItem>
			<MudMenuItem Icon="@Icons.Material.Filled.SaveAs" IconSize="Size.Small" OnClick="OnSaveAsClick" Disabled="@(!RomLoaded)">Save As...</MudMenuItem>
			<MudDivider />
			<MudMenuItem Icon="@Icons.Material.Filled.GetApp" IconSize="Size.Small" OnClick="OnExportClick" Disabled="@(!RomLoaded)">Export...</MudMenuItem>
			<MudDivider />
			<MudMenuItem Icon="@Icons.Material.Filled.ExitToApp" IconSize="Size.Small" OnClick="OnExitClick">Exit</MudMenuItem>
		</MudMenu>

		<MudMenu Label="Edit" Variant="Variant.Text" Size="Size.Small" Dense="true" Class="pa-0 ma-0">
			<MudMenuItem Icon="@Icons.Material.Filled.Undo" IconSize="Size.Small" OnClick="OnUndoClick" Disabled="true">Undo</MudMenuItem>
			<MudMenuItem Icon="@Icons.Material.Filled.Redo" IconSize="Size.Small" OnClick="OnRedoClick" Disabled="true">Redo</MudMenuItem>
			<MudDivider />
			<MudMenuItem Icon="@Icons.Material.Filled.ContentCut" IconSize="Size.Small" OnClick="OnCutClick" Disabled="true">Cut</MudMenuItem>
			<MudMenuItem Icon="@Icons.Material.Filled.ContentCopy" IconSize="Size.Small" OnClick="OnCopyClick" Disabled="true">Copy</MudMenuItem>
			<MudMenuItem Icon="@Icons.Material.Filled.ContentPaste" IconSize="Size.Small" OnClick="OnPasteClick" Disabled="true">Paste</MudMenuItem>
			<MudDivider />
			<MudMenuItem Icon="@Icons.Material.Filled.SelectAll" IconSize="Size.Small" OnClick="OnSelectAllClick" Disabled="true">Select All</MudMenuItem>
		</MudMenu>

		<MudMenu Label="Help" Variant="Variant.Text" Size="Size.Small" Dense="true" Class="pa-0 ma-0">
			<MudMenuItem Icon="@Icons.Material.Filled.Help" IconSize="Size.Small" OnClick="OnHelpClick">Documentation</MudMenuItem>
			<MudMenuItem Icon="@Icons.Material.Filled.Keyboard" IconSize="Size.Small" OnClick="OnKeyboardShortcutsClick">Keyboard Shortcuts</MudMenuItem>
			<MudDivider />
			<MudMenuItem Icon="@Icons.Material.Filled.Info" IconSize="Size.Small" OnClick="OnAboutClick">About</MudMenuItem>
		</MudMenu>
	</MudToolBar>
</MudPaper>

<div class="container-fluid mt-4">
	@* Hidden file upload for menu access *@
	<div style="display: none;">
		<MudFileUpload @ref="_hiddenFileUpload" Accept=".nes" T="IBrowserFile" FilesChanged="UploadFiles" />
	</div>
	@if (Loading)
	{
		<div class="row">
			<div class="col-12" style="height:500px;">
				<div class="spinner">
					<MudProgressCircular Color="Color.Default" Indeterminate="true" />
				</div>
			</div>
		</div>
	}
	else if (RomLoaded)
	{
		<div class="row">
			<!-- Palette Panel -->
			<div class="col-md-5">
				<MudPaper Class="p-3">
					<MudText Typo="Typo.h6">2) Choose 4 colors from palette</MudText>

					<_NesColors @bind-SelectedColor="@SelectedNesColor"></_NesColors>

					<MudText Typo="Typo.h6" Class="mt-4">3) Choose from palette</MudText>

					<_ColorPalette @bind-SelectedPaletteIndex="SelectedPaletteIndex"
								   @bind-Slot1Color="Slot1NesColor"
								   @bind-Slot2Color="Slot2NesColor"
								   @bind-Slot3Color="Slot3NesColor"
								   SelectedNesColor="@SelectedNesColor"
								   SelectedNesColorChanged="OnSelectedNesColorChanged">
					</_ColorPalette>

				</MudPaper>
			</div>

			<!-- Canvas Panel -->
			<_SpriteEditor Saved="OnSpriteSaved" Sprite="@SelectedSprite"
						   Slot1Color="Slot1NesColor"
						   Slot2Color="Slot2NesColor"
						   Slot3Color="Slot3NesColor"
						   SelectedNesColor="@SelectedNesColor">

			</_SpriteEditor>

		</div>
		<div class="row mt-4 d-flex gap-1">
			@foreach (var sprite in Sprites)
			{
				<_SpritePreview SpriteClicked="OnSpritePreviewClicked"
								Sprite="@sprite"
								Slot1Color="Slot1NesColor"
								Slot2Color="Slot2NesColor"
								Slot3Color="Slot3NesColor">
				</_SpritePreview>
			}
		</div>
	}

</div>

@code {

	private SpriteSheet? _simonSpriteSheet = null;
	private NesROM? _rom = null;
	private MudFileUpload<IBrowserFile>? _hiddenFileUpload;

	protected bool RomLoaded { get; set; } = false;
	protected bool Loading { get; set; } = false;
	protected ISprite? SelectedSprite { get; set; } = null;
	protected NesColor? SelectedNesColor { get; set; } = null;
	protected int SelectedPaletteIndex { get; set; } = 0;

	protected NesColor? Slot1NesColor { get; set; } = null;
	protected NesColor? Slot2NesColor { get; set; } = null;
	protected NesColor? Slot3NesColor { get; set; } = null;

	private int SpriteCount = 18;
	protected List<ISprite> Sprites { get; set; } = new();

	protected MemoryStream? _nesGameBytes = null;
	private IJSObjectReference? _jsObjectReference = null;

	// File Menu Handlers
	private async Task OnOpenRomClick()
	{
		// Trigger the hidden file upload dialog
		if (_hiddenFileUpload != null)
		{
			await _hiddenFileUpload.OpenFilePickerAsync();
			Loading = true;
			StateHasChanged();	
		}
	}

	private async Task OnSaveClick()
	{
		// Quick save to current file
		await OnDownloadClick();
	}

	private async Task OnSaveAsClick()
	{
		// Save with new name
		await OnDownloadClick();
	}

	private async Task OnExportClick()
	{
		// Export functionality
		_logger.LogInformation("Export clicked");
	}

	private void OnExitClick()
	{
		// Close application or navigate away
		_logger.LogInformation("Exit clicked");
	}

	// Edit Menu Handlers
	private void OnUndoClick()
	{
		_logger.LogInformation("Undo clicked");
	}

	private void OnRedoClick()
	{
		_logger.LogInformation("Redo clicked");
	}

	private void OnCutClick()
	{
		_logger.LogInformation("Cut clicked");
	}

	private void OnCopyClick()
	{
		_logger.LogInformation("Copy clicked");
	}

	private void OnPasteClick()
	{
		_logger.LogInformation("Paste clicked");
	}

	private void OnSelectAllClick()
	{
		_logger.LogInformation("Select All clicked");
	}

	// Help Menu Handlers
	private async Task OnHelpClick()
	{
		// Open documentation
		await _jsRuntime.InvokeVoidAsync("window.open", "https://github.com/yourdocs", "_blank");
	}

	private void OnKeyboardShortcutsClick()
	{
		// Show keyboard shortcuts dialog
		_logger.LogInformation("Keyboard shortcuts clicked");
	}

	private void OnAboutClick()
	{
		// Show about dialog
		_logger.LogInformation("About clicked");
	}

	protected async Task OnSpritePreviewClicked(ISprite sprite)
	{
		SelectedSprite = sprite;
	}

	protected void OnSelectedNesColorChanged(NesColor? newColor)
	{
		SelectedNesColor = newColor;
	}

	protected void LoadPalette(int[] palette)
	{
		Slot1NesColor = NesColorsUtils.NesColorIndexToNesColor(palette[0]);
		Slot2NesColor = NesColorsUtils.NesColorIndexToNesColor(palette[1]);
		Slot3NesColor = NesColorsUtils.NesColorIndexToNesColor(palette[2]);
	}

	protected override async Task OnInitializedAsync()
	{
		var contnet = await _presetClient.LoadPreset("cv2-simon-presets"); 
	}

	protected async Task OnSpriteSaved(ISprite sprite)
	{
		var spritesToSave = sprite.Flatten(true);
		// todo: make something which consumes individual sprites, not just whole sheets.
		var sheets = await _rom.GetSpriteSheets();
		foreach (var spriteToSave in spritesToSave)
		{
			var sheet = sheets[spriteToSave.SheetNumber];
			sheet.Sprites[spriteToSave.SpriteIndex] = spriteToSave;
		}
		await _rom.SaveSpriteSheets(sheets);
	}

	protected async Task OnDownloadClick()
	{
		if (_jsObjectReference != null)
		{
			using var memoryStream = new MemoryStream();
			await _rom.SaveToStream(memoryStream);
			memoryStream.Seek(0, SeekOrigin.Begin);
			using var streamRef = new DotNetStreamReference(stream: memoryStream);

			await _jsObjectReference.InvokeVoidAsync("downloadFile", "cv2-edited.nes", streamRef);
		}
	}

	[JSInvokable]
	public Task OnGlobalNumberKey(string key)
	{
		bool triggerKeyClicked = false;
		if (RomLoaded && !Loading)
		{
			switch (key)
			{
				case "1":
					Log.Information("Key 1 pressed.");
					SelectedPaletteIndex = 0;
					triggerKeyClicked = true;
					break;
				case "2":
					Log.Information("Key 2 pressed.");
					SelectedPaletteIndex = 1;
					triggerKeyClicked = true;
					break;
				case "3":
					Log.Information("Key 3 pressed.");
					SelectedPaletteIndex = 2;
					triggerKeyClicked = true;
					break;
				case "4":
					Log.Information("Key 4 pressed.");
					SelectedPaletteIndex = 3;
					triggerKeyClicked = true;
					break;
			}
		}

		if (triggerKeyClicked)
		{
			StateHasChanged();
		}

		// State has changed; re-render so LastKey appears in the UI
		return Task.CompletedTask;
	}

	private DotNetObjectReference<Home> _objRef;

	public void Dispose()
	{
		// clean up the JS reference to avoid leaks
		_objRef?.Dispose();
	}

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			// create a JS reference to *this* component
			_objRef = DotNetObjectReference.Create(this);

			// call your JS initializer, passing the reference
			await _jsRuntime.InvokeVoidAsync("globalKeyListener.initialize", _objRef);
		}

		if (_jsObjectReference == null)
		{
			_jsObjectReference = await _jsRuntime.InvokeAsync<IJSObjectReference>("import", "./Pages/Home.razor.js");
		}
	}

	protected async Task UploadFiles(IBrowserFile file)
	{

		Log.Information("upload files clicked.");

		// just gives the spinner a second on super fast loads.
		// otherwise things look a tad jumpy.
		await Task.Delay(TimeSpan.FromSeconds(1));

		_nesGameBytes = new MemoryStream(275_000);
		await file.OpenReadStream().CopyToAsync(_nesGameBytes);
		_rom = new NesROM();
		await _rom.Load(_nesGameBytes);

		var sheets = await _rom.GetSpriteSheets();

		var simonSheet1 = sheets[1];

		// for demo of loading simon.
		//var sprite1 = simonSheet1.Sprites[1];
		//var sprite2 = simonSheet1.Sprites[2];

		LoadPalette(Constants.SimonPalette);

		// SelectedSprite = CompositeSprite.Create([sprite1, sprite2], SpriteOrientationEnum.Horizontal);

		Sprites.Clear();

		for (int i = 0; i < SpriteCount; i++)
		{
			var spriteA = simonSheet1.Sprites[i];

			Sprites.Add(spriteA); 
		}

		RomLoaded = true;
		Loading = false;
	}
}



<style>

	.spinner {
		position: absolute;
		height: 100vh;
		width: 100%;
		top: 50%;
		left: 50%;
		margin-left: -50px;
		margin-top: -50px;
		background: url(/link/to/your/image);
		background-size: 100%;
	}

	/* Palette grid: 16 columns */
	.palette-grid {
		display: grid;
		grid-template-columns: repeat(16, 24px);
		grid-gap: 4px;
	}

	.color-cell {
		width: 24px;
		height: 24px;
		border: 1px solid #444;
		cursor: pointer;
	}

	.no-select {
		/* Prevent any selection or caret showing up */
		user-select: none; /* standard */
		-webkit-user-select: none; /* Safari/Chrome */
		-ms-user-select: none; /* IE/Edge */
		/* Hide the blinking caret if focus does land there */
		caret-color: transparent;
		/* Remove the focus outline so nothing shows when you click */
		outline: none;
	}

	/* Selected palette slots */
	.selected-colors .selected-color-cell {
		width: 40px;
		height: 40px;
		border: 1px solid #444;
		margin-right: 8px;
		cursor: pointer;
	}


	/* Sprite canvas: 16×16 pixels */
	.sprite-canvas {
		display: grid;
		grid-template-columns: repeat(16, 20px);
		grid-template-rows: repeat(16, 20px);
	}

	.pixel {
		width: 20px;
		height: 20px;
		border: 1px solid #ccc;
		cursor: pointer;
	}

	.background {
		background: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' version='1.1' preserveAspectRatio='none' viewBox='0 0 100 100'><path d='M100 0 L0 100 ' stroke='black' stroke-width='1'/><path d='M0 0 L100 100 ' stroke='black' stroke-width='1'/></svg>");
		background-repeat: no-repeat;
		background-position: center center;
		background-size: 100% 100%, auto;
	}
</style>